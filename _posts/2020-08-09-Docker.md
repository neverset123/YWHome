---
layout:     post
title:      docker
subtitle:   
date:       2020-08-09
author:     neverset
header-img: img/post-bg-kuaidi.jpg
catalog: true
tags:
    - docker
---

## dockerfile tips
### caching
For an efficient use of the caching mechanism , we need to place the instructions for layers that change frequently after the ones that incur less changes.
applicationâ€™s dependencies change less frequently than the Python code. Therefore we copy the dependencies file and install them and then we copy the source code

    # copy the dependencies file to the working directory
    COPY requirements.txt .
    # install dependencies
    RUN pip install -r requirements.txt
    # copy the content of the local src directory to the working directory
    COPY src/ .

### Multi-stage builds
using multi-stage builds can strip the final application image of all unnecessary files and software packages and deliver only the files needed to run our Python code.

    # first stage
    FROM python:3.8 AS builder
    COPY requirements.txt .
    # install dependencies to the local user directory (eg. /root/.local)
    RUN pip install --user -r requirements.txt
    # second unnamed stage
    FROM python:3.8-slim
    WORKDIR /code
    # copy only the dependencies installation from the 1st stage image
    COPY --from=builder /root/.local/bin /root/.local
    COPY ./src .
    # update PATH environment variable
    ENV PATH=/root/.local:$PATH
    CMD [ "python", "./server.py" ] 

## Compose file tips

to start up all services
    docker-compose up -d
to stop and remove all project containers
    docker-compose down
to rebuild images
    docker-compose build
to check logs
    docker-compose logs app

### Network separation
to avoid all service in same default network, we need to define separate networks for unrelevant components
### Docker Volumes
To persist DB data between different containers, we can exploit named volumes.
### Docker Secrets

    version: "3.7"
    services:
    db:
        image: mysql:8.0.19
        command: '--default-authentication-plugin=mysql_native_password'
        restart: always
        secrets:
        - db-password
        volumes:
        - db-data:/var/lib/mysql
        networks:
        - backend-network
        environment:
        - MYSQL_DATABASE=example
        - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/db-password

    app:
        build: app
        restart: always
        secrets:
        - db-password
        networks:
        - backend-network
        - frontend-network

    web:
        build: web
        restart: always
        ports:
        - 80:80
        networks:
        - frontend-network
    volumes:
    db-data:
    secrets:
    db-password:
        file: db/password.txt
    networks:
    backend-network:
    frontend-network:

## Applying Code Updates & debugging
### update code updates
during debugging, we can bind-mount the source code to container, so that we can debug code without rebuild image and redeploy container

  app:
    build: app
    restart: always
    volumes:
      - ./app/src:/code

 A reloader watches all the source code files and automatically restarts the server when detects that a file has changed. To enable the debug mode we only need to set the debug parameter as below:

    #server.py
    server.run(debug=True, host='0.0.0.0', port=5000)

## debugging
* map locally the port to the debugger
    app:
        build: app
        restart: always
        volumes:
            - ./app/src:/code
        ports:
            - 5678:5678
* import dubugger modul
vs code support ptvsd

    import ptvsd
    ptvsd.enable_attach(address=('0.0.0.0', 5678))

* create remote launch

    #in launch.json file
    {
        "version": "0.2.0",
        "configurations": [
            {
                "name": "Python: Remote Attach",
                "type": "python",
                "request": "attach",
                "port": 5678,
                "host": "localhost",
                "pathMappings": [
                    {
                        "localRoot": "${workspaceFolder}/app/src",
                        "remoteRoot": "/code"
                    }
                ]
            }
        ]
    }